---
- name: Restart Minecraft Server to Unban Players
  hosts: all
  become: true  # Run all tasks with sudo
  tasks:

    - name: Send in-game warning message about impending restart
      ansible.builtin.shell: |
        sudo -u mcserver screen -S minecraft -p 0 -X stuff 'say Server omstart om 10 sekunder for Ã¥ oppheve bannlysning av spillere!^M'
      chdir: /home/mcserver/minecraft

    - name: Countdown before restart
      ansible.builtin.shell: |
        for i in {10..1}; do
          sudo -u mcserver screen -S minecraft -p 0 -X stuff "say Omstart om $i sekunder!^M"
          sleep 1
        done
      chdir: /home/mcserver/minecraft

    - name: Stop Minecraft server
      ansible.builtin.systemd:
        name: minecraftserver.service
        state: stopped

    - name: Remove banned-players.json
      ansible.builtin.file:
        path: /home/mcserver/minecraft/banned-players.json
        state: absent

    - name: Start Minecraft server
      ansible.builtin.systemd:
        name: minecraftserver.service
        state: started

    - name: Pause for 5 seconds to ensure Minecraft service is fully started
      pause:
        seconds: 5

    - name: Wait for Minecraft service to be started
      ansible.builtin.systemd:
        name: minecraftserver.service
        state: started
      register: result

    - name: Print Minecraft server status
      ansible.builtin.debug:
        msg: "Minecraft server status: {{ result }}"
